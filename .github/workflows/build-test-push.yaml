name: sprobot build, test, and maybe push

on:
  push:
    branches-ignore: # Dependabot branches get ran through pull_request
      - 'dependabot/**'
  pull_request:
  schedule:
    - cron: '0 5 * * 1,3,5'

jobs:
  lint:
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
      fail-fast: true
    runs-on: ${{ matrix.runner }}

    steps:
      - name: checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and don't push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: sprobot-local-lint
          target: lint
          platforms: ${{ matrix.platform }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}

      - name: run linters against it
        run: docker run --platform ${{ matrix.platform }} sprobot-local-lint
        
  test:
    needs: [lint]
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - name: checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and don't push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: sprobot-local-test
          target: test
          platforms: ${{ matrix.platform }}
          cache-from: type=gha,scope=${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=${{ matrix.platform }}

      - name: run tests+linters against it
        run: docker run --platform ${{ matrix.platform }} sprobot-local-test


  gotest:
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
      fail-fast: true
    runs-on: ${{ matrix.runner }}
    steps:
      - name: checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build gotest image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: sprobot-gotest
          target: gotest
          platforms: ${{ matrix.platform }}
          cache-from: type=gha,scope=go-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=go-${{ matrix.platform }}

      - name: Run Go vet and tests
        run: docker run --platform ${{ matrix.platform }} sprobot-gotest

  publish-build:
    needs: [test, lint, gotest]
    if: startsWith(github.ref, 'refs/heads/main')
    strategy:
      matrix:
        include:
          - image: sadbox/sprobot
            target: prod
            platform: linux/amd64
            runner: ubuntu-latest
            cache-scope: publish-prod-amd64
            cache-prefix: ""
          - image: sadbox/sprobot
            target: prod
            platform: linux/arm64
            runner: ubuntu-24.04-arm
            cache-scope: publish-prod-arm64
            cache-prefix: ""
          - image: sadbox/sprobot-go
            target: prodgobot
            platform: linux/amd64
            runner: ubuntu-latest
            cache-scope: publish-gobot-amd64
            cache-prefix: go-
          - image: sadbox/sprobot-go
            target: prodgobot
            platform: linux/arm64
            runner: ubuntu-24.04-arm
            cache-scope: publish-gobot-arm64
            cache-prefix: go-
          - image: sadbox/sprobot-go-web
            target: prodgoweb
            platform: linux/amd64
            runner: ubuntu-latest
            cache-scope: publish-goweb-amd64
            cache-prefix: go-
          - image: sadbox/sprobot-go-web
            target: prodgoweb
            platform: linux/arm64
            runner: ubuntu-24.04-arm
            cache-scope: publish-goweb-arm64
            cache-prefix: go-
    runs-on: ${{ matrix.runner }}
    steps:
      - name: checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          target: ${{ matrix.target }}
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=${{ matrix.image }},push-by-digest=true,name-canonical=true,push=true
          cache-from: |
            type=gha,scope=${{ matrix.cache-prefix }}${{ matrix.platform }}
            type=gha,scope=${{ matrix.cache-scope }}
          cache-to: type=gha,mode=max,scope=${{ matrix.cache-scope }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          echo "${{ steps.build.outputs.digest }}" > /tmp/digests/digest.txt

      - name: Compute artifact name
        run: |
          image="${{ matrix.image }}"
          platform="${{ matrix.platform }}"
          echo "ARTIFACT_NAME=digest-${image//\//-}-${platform//\//-}" >> "$GITHUB_ENV"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: /tmp/digests/digest.txt
          retention-days: 1

  publish-merge:
    needs: [publish-build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - image: sadbox/sprobot
            artifact-prefix: digest-sadbox-sprobot
          - image: sadbox/sprobot-go
            artifact-prefix: digest-sadbox-sprobot-go
          - image: sadbox/sprobot-go-web
            artifact-prefix: digest-sadbox-sprobot-go-web
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Download amd64 digest
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact-prefix }}-linux-amd64
          path: /tmp/digests/amd64

      - name: Download arm64 digest
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact-prefix }}-linux-arm64
          path: /tmp/digests/arm64

      - name: Create manifest and push
        run: |
          AMD64_DIGEST=$(cat /tmp/digests/amd64/digest.txt)
          ARM64_DIGEST=$(cat /tmp/digests/arm64/digest.txt)
          docker buildx imagetools create \
            -t ${{ matrix.image }}:latest \
            ${{ matrix.image }}@${AMD64_DIGEST} \
            ${{ matrix.image }}@${ARM64_DIGEST}
